name: Android CI
on:
  push:
    branches: [ main ]
jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest

    # חוזרים להשתמש בסביבת Docker יציבה ומוכנה מראש
    container:
      image: mingc/android-build-box:latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Python dependencies inside container
      run: |
        # הסביבה בתוך ה-container כבר כוללת את רוב הכלים
        apt-get update
        apt-get install -y python3-pip
        pip3 install --upgrade pip
        pip3 install 'buildozer==1.5.0' 'cython==0.29.36'

    - name: Create complete buildozer.spec manually
      run: |
        # יוצרים קובץ spec מלא ותקין כדי למנוע את כל השגיאות הקודמות
        echo "[buildozer]" > buildozer.spec
        echo "warn_on_root = 0" >> buildozer.spec
        echo "log_level = 2" >> buildozer.spec
        echo "" >> buildozer.spec
        echo "[app]" >> buildozer.spec
        echo "title = MyApp" >> buildozer.spec
        echo "package.name = myapp" >> buildozer.spec
        echo "package.domain = com.example" >> buildozer.spec
        echo "source.dir = ." >> buildozer.spec
        echo "source.include_exts = py,png,jpg,kv,atlas" >> buildozer.spec
        echo "version = 1.0.0" >> buildozer.spec
        echo "requirements = python3,kivy" >> buildozer.spec
        echo "orientation = portrait" >> buildozer.spec
        echo "fullscreen = 0" >> buildozer.spec
        echo "android.api = 33" >> buildozer.spec
        echo "android.minapi = 21" >> buildozer.spec
        echo "android.sdk_build_tools = 34.0.0" >> buildozer.spec
        echo "android.permissions = INTERNET" >> buildozer.spec
        echo "android.archs = arm64-v8a, armeabi-v7a" >> buildozer.spec
        echo "p4a.branch = master" >> buildozer.spec

    - name: Build APK with Buildozer
      run: |
        # מדלגים על init, ומריצים ישירות את הבנייה
        buildozer -v android debug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: MyApp-debug.apk
        path: bin/*.apk
